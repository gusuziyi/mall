var url=require('url');
var fs=require('fs');
var events=require('events');
var router=function(){
	var Policys=this;//策略函数集
	this._get={};
	this._post={};
	var app=function(req,res){
		resEx(res);
		var target_method=req.method.toLowerCase();
		var target_pathname=url.parse(req.url).pathname;
		if(target_pathname.startsWith('/'))
			target_pathname=target_pathname.replace('/','');
		if(target_pathname!='favicon.ico')
			loadPage(Policys,target_pathname,target_method,req,res);
	}	
	app.get=function(string,cb){
		Policys._get[string]=cb;
	} 
	app.post=function(string,cb){
		Policys._post[string]=cb;
	}
	return app;
};
function resEx(res){
	res.send=function(data){
		res.writeHead(200,{'content-type':'text/html'});
		console.log(data);
		res.end(data);
	};
}

function loadPage(Policys,target_pathname,target_method,req,res){
	var ev=new events.EventEmitter();
	fs.readFile('./html/'+target_pathname+'.html', function(err,datas){
		if(target_method=='get'){
			var target_query=url.parse(req.url,true).query;
			console.log(target_query);
		}
		else if(target_method=='post') {
			var dataFs='';
			req.on('data',function(trunk){
				dataFs+=trunk;
			});
			req.on('end',function(){
				var target_query=dataFs;
				ev.emit('userInfo',target_query);
							// console.log(dataFs);//用户名密码,低速函数
						});
			ev.on('userInfo',function(userInfo){
				console.log(userInfo);
			});
		}
		if(Policys["_"+target_method][target_pathname]) {
			Policys["_"+target_method][target_pathname](req,res);
		}else 	
		res.send('no router');
	});
}
module.exports=router();//要运行才能拿到app