var doMongo=function () {
	var Policys=this;    //数据库函数集
	var DBurl="mongodb://127.0.0.1:27017/"
	var dbo=function(_do,data1,data2,cb){
		if(Policys[_do])
			Policys[_do](data1,data2,cb);
	}
	dbo.init=function(_do,_func){  //用户自定义数据库函数
		if(!Policys[_do])
			Policys[_do]=_func;
	}
	initPolicys(DBurl,Policys); // 默认函数:增删改查
	return dbo;
}
function initPolicys(DBurl,Policys){
	var MongoClient=require('mongodb').MongoClient;
	var cookies=require('cookie-Parser');
	Policys.add=function(data,cb){
		// console.log(data);
		MongoClient.connect(DBurl,{useNewUrlParser:true},function(err, db) {
			if (err) {
				// console.log("数据库连接异常"+err);
				cb("数据库连接异常"+err);
			}
			var conn=db.db('tests');
			conn.collection('users').find({"username":data}).toArray(function(err2,datas){
				var n=datas.length;
				if(!n){
					conn.collection('users').insertOne({
						'username':data
					});
					cb("添加成功");
				}else{
					cb("用户已存在,请登录");
				}
				db.close();
			});
		});
	}
	Policys.delete=function(data,cb){
		MongoClient.connect(DBurl,{useNewUrlParser:true},function(err, db) {
			if (err) {
				console.log("数据库连接异常"+err);
				cb("数据库连接异常"+err);
			}
			var conn=db.db('tests');
			conn.collection('users').find({"username":data}).toArray(function(err2,datas){
				var n=datas.length;
				if(!n){
					cb("用户不存在");
				}else{
					conn.collection('users').deleteOne({'username':data },function(err, obj) {
						if (err) throw err;
						cb("删除成功");
					});
				}
				db.close();
			});
			
		});
	}
	Policys.update=function(data_old,data_new,cb){
		MongoClient.connect(DBurl,{useNewUrlParser:true},function(err, db) {
			if (err) {
				console.log("数据库连接异常"+err);
				return false;
			}
			var conn=db.db('tests');
			conn.collection('users').updateOne({'username':data_old },{ $set:{'username': data_new } },function(err2,info){
				if(err)
					cb("更新失败"+err2);
				else{
					var n=info.result.nModified;
					if(n==0)
						cb("已存在相同记录");
					else
						cb("更新成功"+n+"个");
				}
				
			});
			db.close();
		});
	}
	Policys.find=function(data,cb){
		MongoClient.connect(DBurl,{useNewUrlParser:true},function(err, db) {
			if (err) {
				console.log("数据库连接异常"+err);
				return false;
			}
			var conn=db.db('tests');
			conn.collection('users').find({'username':data }).toArray(function(err,datas){
				if(datas.length==0)
					cb(false);
				else
					cb(datas);
			});
			db.close();
		});
	}
}
module.exports=doMongo();